<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Laporan Toko</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:#f4f6fb;
  min-height:100vh;
}
.container{max-width:1200px;margin:25px auto;padding:0 15px}
.card{background:#fff;border-radius:14px;padding:24px;box-shadow:0 8px 22px rgba(0,0,0,.08)}
.login-wrap{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
}
.login{max-width:420px;width:100%}
.login h1{text-align:center;font-size:24px;margin-bottom:5px}
.subtitle{text-align:center;color:#64748b;font-size:14px;margin-bottom:25px}

.form-group{margin-bottom:18px}
.form-group label{font-size:13px;font-weight:600;color:#475569;margin-bottom:6px;display:block}
.form-group input{
  width:100%;
  padding:12px 14px;
  border-radius:10px;
  border:1px solid #cbd5e1;
  font-size:15px
}
.form-group input:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 2px rgba(37,99,235,.15)
}

button{
  padding:12px;
  border-radius:10px;
  border:none;
  font-weight:600;
  cursor:pointer;
  color:#fff
}
.primary{background:#2563eb}
.primary:hover{background:#1d4ed8}
.secondary{background:#546e7a}
.success{background:#43a047}
.warning{background:#fb8c00}
.danger{background:#e53935}
.refresh{background:#26a69a}

.menu{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
  margin-top:15px
}

.actions{margin-top:15px;display:flex;gap:10px;flex-wrap:wrap}
.iframe-box{position:relative;margin-top:18px}
iframe{width:100%;height:78vh;border-radius:14px;border:none}

.loading{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:600;
  color:#2563eb;
  z-index:10
}

.notice{
  background:#fff8e1;
  border-left:5px solid #ffb300;
  padding:12px;
  border-radius:8px;
  margin:15px 0;
  font-size:14px
}
.notice a{color:#e65100;font-weight:600;text-decoration:none}

.footer{text-align:center;margin:20px 0;font-size:13px;color:#666}
.center{text-align:center}
</style>
</head>

<body>
<div id="root"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCld9VE6XdF-tbcv1E-gBZ2ACeJBklW-Go",
  authDomain: "server-laporan.firebaseapp.com",
  databaseURL: "https://server-laporan-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "server-laporan"
});
const rtdb=firebase.database();
const {useState}=React;

const fmt=d=>String(d.getDate()).padStart(2,"0")+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+d.getFullYear();
const today=()=>fmt(new Date());
const deviceId=()=>navigator.userAgent+"-"+screen.width+"x"+screen.height;

const greeting=()=>{
 const h=new Date().getHours();
 if(h<11)return"Selamat pagi";
 if(h<15)return"Selamat siang";
 if(h<18)return"Selamat sore";
 return"Selamat malam";
};

function App(){
const[user,setUser]=useState(null);
const[username,setUsername]=useState("");
const[menu,setMenu]=useState("");
const[date,setDate]=useState("");
const[start,setStart]=useState("");
const[end,setEnd]=useState("");
const[src,setSrc]=useState("");
const[loading,setLoading]=useState(false);

const login=async()=>{
 const snap=await rtdb.ref("userList").once("value");
 let found=null,key=null;
 Object.entries(snap.val()||{}).forEach(([k,u])=>{
  if(u.username?.toUpperCase()===username){found=u;key=k;}
 });
 if(!found)return alert("User tidak terdaftar");
 if(new Date(found.expired)<new Date())return alert("Akun expired");

 const myDevice=deviceId();
 if(found.deviceId && found.deviceId!==myDevice)
  return alert("Akun ini sudah login di device lain");

 if(!found.deviceId)
  rtdb.ref("userList/"+key+"/deviceId").set(myDevice);

 setUser(found);
};

const openAuto=m=>{
 setMenu(m);setDate("");setStart("");setEnd("");
 let url="";
 if(m==="last")url=`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_last_so_absolute_desc?storeId=${user.storeId}&dateSo=${today()}`;
 if(m==="notmain")url=`https://app.alfastore.co.id/prd/api/rpt/laporan/laporan_plu_tak_main_toko?storeId=${user.storeId}&dateTx=${today()}`;
 if(m==="disc")url=`https://app.alfastore.co.id/prd/api/rpt/laporan/rpt_plu_discontinue?storeId=${user.storeId}&dateSo=${today()}&filter_tag=All`;
 setLoading(true);setSrc(url+"&t="+Date.now());
};

const loadManual=()=>{
 let url="";
 if(menu==="adjust"){
  if(!date)return alert("Pilih tanggal");
  url=`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_all_so_absolute_desc?storeId=${user.storeId}&dateSo=${date}`;
 }
 if(menu==="daily"){
  if(!start||!end)return alert("Pilih tanggal");
  url=`https://app.alfastore.co.id/prd/api/rpt/laporan/daily_performance?storeId=${user.storeId}&periode1=${start}&periode2=${end}`;
 }
 setLoading(true);setSrc(url+"&t="+Date.now());
};

const load2324=()=>{
 if(!date)return alert("Pilih tanggal");
 const url=`https://app.alfastore.co.id/prd/api/rpt/laporan/rep_gabungan_23_24?storeId=${user.storeId}&periode1=${date}`;
 setLoading(true);setSrc(url+"&t="+Date.now());
};

if(!user){
 return React.createElement("div",{className:"login-wrap"},
  React.createElement("div",{className:"login card"},
   React.createElement("h1",null,"Sistem Laporan Toko"),
   React.createElement("div",{className:"subtitle"},"Login User"),
   React.createElement("div",{className:"form-group"},
    React.createElement("label",null,"Username"),
    React.createElement("input",{
      value:username,
      placeholder:"Masukkan username",
      onChange:e=>setUsername(e.target.value.toUpperCase())
    })
   ),
   React.createElement("button",{className:"primary",onClick:login},"LOGIN")
  )
 );
}

return React.createElement("div",{className:"container"},
 React.createElement("div",{className:"card"},
  React.createElement("h3",null,`${greeting()} ${user.username} ðŸ‘‹`),

  React.createElement("div",{className:"notice"},
   "ðŸ“¢ Wajib join grup WhatsApp untuk info & update â†’ ",
   React.createElement("a",{href:"https://chat.whatsapp.com/J4CLPxvk942FEufV5FIxY3",target:"_blank"},"JOIN GRUP")
  ),

  React.createElement("div",{className:"menu"},
   React.createElement("button",{className:"primary",onClick:()=>openAuto("last")},"Selisih Terakhir"),
   React.createElement("button",{className:"secondary",onClick:()=>{setMenu("adjust");setSrc("");}},"SO Adjust"),
   React.createElement("button",{className:"danger",onClick:()=>{setMenu("daily");setSrc("");}},"Daily Performance"),
   React.createElement("button",{className:"success",onClick:()=>openAuto("notmain")},"PLU Tidak Main"),
   React.createElement("button",{className:"warning",onClick:()=>openAuto("disc")},"Discontinue"),
   React.createElement("button",{className:"warning",onClick:()=>{setMenu("lap2324");setSrc("");}},"ðŸ“Š Laporan 23â€“24")
  ),

  menu==="adjust"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setDate(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:loadManual},"Tampilkan")
  ),

  menu==="daily"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setStart(fmt(new Date(e.target.value)))}),
   React.createElement("input",{type:"date",onChange:e=>setEnd(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:loadManual},"Tampilkan")
  ),

  menu==="lap2324"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setDate(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:load2324},"Tampilkan")
  )
 ),

 src&&React.createElement("div",{className:"iframe-box"},
  loading&&React.createElement("div",{className:"loading"},"â³ Memuat laporan..."),
  React.createElement("iframe",{src,onLoad:()=>setLoading(false)})
 ),

 src&&React.createElement("div",{className:"center",style:{marginTop:15}},
  React.createElement("button",{className:"refresh",onClick:()=>{setLoading(true);setSrc(src+"&r="+Date.now());}},"ðŸ”„ Refresh"),
  React.createElement("button",{className:"danger",style:{marginLeft:10},onClick:()=>{setUser(null);setSrc("");}},"Logout")
 ),

 React.createElement("div",{className:"footer"},"Â© "+new Date().getFullYear()+" Sistem Laporan Toko")
);
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
