<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Sistem Laporan Toko</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
body{
  margin:0;
  font-family:"Segoe UI",Arial;
  background:#f4f6fb;
}

/* ===== LOGIN CENTER ===== */
.center{
  min-height:100vh;
  display:flex;
  align-items:center;
  justify-content:center;
  padding:20px;
}

/* ===== CONTAINER ===== */
.container{
  max-width:1200px;
  margin:20px auto;
  padding:0 15px;
}

/* ===== CARD ===== */
.card{
  background:#fff;
  border-radius:20px;
  padding:40px;
  box-shadow:0 12px 35px rgba(0,0,0,.08);
  position:relative;
  z-index:10;
}

/* ===== LOGIN UI FINAL ===== */
.login{
  width:100%;
  max-width:480px;
  padding:50px 45px;
}

.login h1{
  text-align:center;
  font-size:28px;
  font-weight:700;
  color:#0f172a;
  margin-bottom:10px;
}

.login p{
  text-align:center;
  font-size:15px;
  color:#64748b;
  margin-bottom:32px;
}

.form-group{
  margin-bottom:22px;
}

.form-group label{
  display:none;
}

.form-group input{
  width:100%;
  padding:18px;
  font-size:16px;
  border-radius:14px;
  border:1px solid #cbd5e1;
}

.form-group input:focus{
  outline:none;
  border-color:#2563eb;
  box-shadow:0 0 0 2px rgba(37,99,235,.15);
}

/* ===== BUTTON ===== */
button{
  cursor:pointer;
  border:none;
  border-radius:14px;
  padding:16px;
  font-size:16px;
  font-weight:600;
  color:#fff;
}

.login button{
  width:100%;
}

.primary{background:#2563eb}
.primary:hover{background:#1d4ed8}
.secondary{background:#475569}
.success{background:#16a34a}
.warning{background:#f59e0b}
.danger{background:#dc2626}
.refresh{background:#0d9488}

/* ===== HEADER ===== */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  flex-wrap:wrap;
  gap:10px;
}

.badge{
  background:#e0f2fe;
  color:#0369a1;
  padding:6px 14px;
  border-radius:20px;
  font-size:13px;
}

/* ===== NOTICE ===== */
.notice{
  background:#fff7ed;
  border-left:5px solid #fb923c;
  padding:14px;
  border-radius:10px;
  margin:18px 0;
}

/* ===== MENU ===== */
.menu{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:12px;
}

/* ===== ACTIONS ===== */
.actions{
  margin-top:15px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;
}

/* ===== IFRAME ===== */
.iframe-box{
  position:relative;
  margin-top:20px;
}

iframe{
  width:100%;
  height:78vh;
  border:none;
  border-radius:18px;
}

/* ===== LOADING ===== */
.loading{
  position:absolute;
  inset:0;
  background:rgba(255,255,255,.85);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:18px;
  font-weight:600;
  color:#2563eb;
  z-index:20;
}

/* ===== FOOTER ===== */
.footer{
  text-align:center;
  margin:18px 0;
  font-size:13px;
  color:#64748b;
}
</style>
</head>

<body>
<div id="root"></div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCld9VE6XdF-tbcv1E-gBZ2ACeJBklW-Go",
  authDomain: "server-laporan.firebaseapp.com",
  databaseURL: "https://server-laporan-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "server-laporan"
});
const rtdb=firebase.database();
const {useState}=React;

const fmt=d=>String(d.getDate()).padStart(2,"0")+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+d.getFullYear();
const today=()=>fmt(new Date());
const deviceId=()=>navigator.userAgent+"-"+screen.width+"x"+screen.height;

const greeting=()=>{
 const h=new Date().getHours();
 if(h<11) return "Selamat Pagi";
 if(h<15) return "Selamat Siang";
 if(h<18) return "Selamat Sore";
 return "Selamat Malam";
};

function App(){
const[user,setUser]=useState(null);
const[username,setUsername]=useState("");
const[menu,setMenu]=useState("");
const[date,setDate]=useState("");
const[start,setStart]=useState("");
const[end,setEnd]=useState("");
const[src,setSrc]=useState("");
const[loading,setLoading]=useState(false);

/* ===== LOGIN LOGIC (TIDAK DIUBAH) ===== */
const login=async()=>{
 if(!username) return alert("Username wajib diisi");
 const snap=await rtdb.ref("userList").once("value");
 let found=null,key=null;
 Object.entries(snap.val()||{}).forEach(([k,u])=>{
  if(u.username?.toUpperCase()===username){found=u;key=k;}
 });
 if(!found) return alert("User tidak terdaftar");
 if(new Date(found.expired)<new Date()) return alert("Akun expired");

 const myDevice=deviceId();
 if(found.deviceId && found.deviceId!==myDevice)
  return alert("Akun sudah digunakan di device lain");

 if(!found.deviceId)
  rtdb.ref("userList/"+key+"/deviceId").set(myDevice);

 setUser(found);
};

/* ===== REPORTS (TIDAK DIUBAH) ===== */
const openAuto=m=>{
 setMenu(m);setDate("");setStart("");setEnd("");
 let url="";
 if(m==="last")url=`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_last_so_absolute_desc?storeId=${user.storeId}&dateSo=${today()}`;
 if(m==="notmain")url=`https://app.alfastore.co.id/prd/api/rpt/laporan/laporan_plu_tak_main_toko?storeId=${user.storeId}&dateTx=${today()}`;
 if(m==="disc")url=`https://app.alfastore.co.id/prd/api/rpt/laporan/rpt_plu_discontinue?storeId=${user.storeId}&dateSo=${today()}&filter_tag=All`;
 setLoading(true);setSrc(url+"&t="+Date.now());
};

const loadManual=()=>{
 let url="";
 if(menu==="adjust"){
  if(!date) return alert("Pilih tanggal");
  url=`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_all_so_absolute_desc?storeId=${user.storeId}&dateSo=${date}`;
 }
 if(menu==="daily"){
  if(!start||!end) return alert("Pilih tanggal");
  url=`https://app.alfastore.co.id/prd/api/rpt/laporan/daily_performance?storeId=${user.storeId}&periode1=${start}&periode2=${end}`;
 }
 setLoading(true);setSrc(url+"&t="+Date.now());
};

const load2324=()=>{
 if(!date) return alert("Pilih tanggal");
 const url=`https://app.alfastore.co.id/prd/api/rpt/laporan/rep_gabungan_23_24?storeId=${user.storeId}&periode1=${date}`;
 setLoading(true);setSrc(url+"&t="+Date.now());
};

/* ===== LOGIN VIEW ===== */
if(!user){
 return React.createElement("div",{className:"center"},
  React.createElement("div",{className:"card login"},
   React.createElement("h1",null,"Login Sistem"),
   React.createElement("p",null,"Masukkan username terdaftar"),
   React.createElement("div",{className:"form-group"},
    React.createElement("input",{
      value:username,
      placeholder:"USERNAME",
      onChange:e=>setUsername(e.target.value.toUpperCase()),
      onKeyDown:e=>{if(e.key==="Enter")login();}
    })
   ),
   React.createElement("button",{className:"primary",onClick:login},"Masuk")
  )
 );
}

/* ===== DASHBOARD ===== */
return React.createElement("div",{className:"container"},
 React.createElement("div",{className:"card"},
  React.createElement("div",{className:"header"},
   React.createElement("h3",null,`${greeting()} ${user.username}`),
   React.createElement("span",{className:"badge"},"Expired: "+user.expired)
  ),
  React.createElement("div",{className:"notice"},
   "ðŸ“¢ Segera join grup WA: ",
   React.createElement("a",{href:"https://chat.whatsapp.com/J4CLPxvk942FEufV5FIxY3",target:"_blank"},"Klik di sini")
  ),
  React.createElement("div",{className:"menu"},
   React.createElement("button",{className:"primary",onClick:()=>openAuto("last")},"Selisih Terakhir"),
   React.createElement("button",{className:"secondary",onClick:()=>{setMenu("adjust");setSrc("");}},"SO Adjust"),
   React.createElement("button",{className:"danger",onClick:()=>{setMenu("daily");setSrc("");}},"Daily Performance"),
   React.createElement("button",{className:"success",onClick:()=>openAuto("notmain")},"PLU Tidak Main"),
   React.createElement("button",{className:"warning",onClick:()=>openAuto("disc")},"Discontinue"),
   React.createElement("button",{className:"warning",onClick:()=>{setMenu("lap2324");setSrc("");}},"ðŸ“Š Laporan 23â€“24")
  ),

  menu==="adjust"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setDate(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:loadManual},"Tampilkan")
  ),

  menu==="daily"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setStart(fmt(new Date(e.target.value)))}),
   React.createElement("input",{type:"date",onChange:e=>setEnd(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:loadManual},"Tampilkan")
  ),

  menu==="lap2324"&&React.createElement("div",{className:"actions"},
   React.createElement("input",{type:"date",onChange:e=>setDate(fmt(new Date(e.target.value)))}),
   React.createElement("button",{className:"primary",onClick:load2324},"Tampilkan")
  ),

  src&&React.createElement("div",{className:"actions"},
   React.createElement("button",{className:"refresh",onClick:()=>{setLoading(true);setSrc(src+"&r="+Date.now());}},"ðŸ”„ Refresh"),
   React.createElement("button",{className:"danger",onClick:()=>{setUser(null);setSrc("");}},"Logout")
  )
 ),

 src&&React.createElement("div",{className:"iframe-box"},
  loading&&React.createElement("div",{className:"loading"},"â³ Memuat laporan..."),
  React.createElement("iframe",{src,onLoad:()=>setLoading(false)})
 ),

 React.createElement("div",{className:"footer"},"Â© "+new Date().getFullYear()+" Sistem Laporan Toko")
);
}

ReactDOM.createRoot(document.getElementById("root"))
.render(React.createElement(App));
</script>
</body>
</html>
