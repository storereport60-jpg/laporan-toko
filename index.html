<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Dashboard Laporan Toko</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- React -->
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

<!-- Firebase COMPAT -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#eef2f6}
.card{background:#fff;border-radius:8px;padding:20px;box-shadow:0 4px 12px rgba(0,0,0,.1)}
.login{max-width:360px;margin:120px auto}
.dashboard{max-width:1100px;margin:20px auto}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
button,input{padding:10px;border-radius:6px;border:1px solid #ccc}
button{color:#fff;border:none;cursor:pointer;font-weight:600}
.primary{background:#1e88e5}
.success{background:#43a047}
.warning{background:#fb8c00}
.danger{background:#e53935}
iframe{width:100%;height:75vh;margin-top:15px;border-radius:6px;border:none}
.header{display:flex;justify-content:space-between;align-items:center}
</style>
</head>

<body>
<div id="root"></div>

<script>
/* ================= FIREBASE INIT ================= */
firebase.initializeApp({
  apiKey: "AIzaSyCld9VE6XdF-tbcv1E-gBZ2ACeJBklW-Go",
  authDomain: "server-laporan.firebaseapp.com",
  databaseURL: "https://server-laporan-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "server-laporan"
});
const rtdb = firebase.database();

/* ================= UTIL ================= */
const {useState} = React;

const formatDate = d =>
  String(d.getDate()).padStart(2,"0")+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+d.getFullYear();

const today = () => formatDate(new Date());

/* ================= APP ================= */
function App(){
  const[user,setUser]=useState(null);
  const[username,setUsername]=useState("");
  const[active,setActive]=useState("");
  const[date,setDate]=useState("");
  const[start,setStart]=useState("");
  const[end,setEnd]=useState("");
  const[src,setSrc]=useState("");

  /* ===== LOGIN (RTDB) ===== */
  const login = async ()=>{
    if(!username) return alert("Masukkan username");

    const snap = await rtdb.ref("userList").once("value");
    const data = snap.val();
    if(!data) return alert("Database kosong");

    let found = null;
    Object.values(data).forEach(u=>{
      if(u.username && u.username.toUpperCase() === username.toUpperCase()){
        found = u;
      }
    });

    if(!found) return alert("User tidak terdaftar");

    if(found.expired && new Date(found.expired) < new Date()){
      return alert("Akun sudah expired");
    }

    setUser({
      u: found.username,
      s: found.storeId,
      e: found.expired
    });
  };

  /* ===== LOAD LAPORAN ===== */
  const load = ()=>{
    if(active==="daily" && (!start || !end))
      return alert("Pilih tanggal awal & akhir");

    if(active!=="daily" && !date)
      return alert("Pilih tanggal");

    const url={
      last:`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_last_so_absolute_desc?storeId=${user.s}&dateSo=${today()}`,
      all:`https://app.alfastore.co.id/prd/api/rpt/laporan_so/csel_all_so_absolute_desc?storeId=${user.s}&dateSo=${date}`,
      plu:`https://app.alfastore.co.id/prd/api/rpt/laporan/laporan_plu_tak_main_toko?storeId=${user.s}&dateTx=${date}`,
      dgs:`https://app.alfastore.co.id/prd/api/rpt/laporan/rpt_plu_discontinue?storeId=${user.s}&dateSo=${date}&filter_tag=All`,
      gab:`https://app.alfastore.co.id/prd/api/rpt/laporan/rep_gabungan_23_24?storeId=${user.s}&periode1=${date}`,
      daily:`https://app.alfastore.co.id/prd/api/rpt/laporan/daily_performance?storeId=${user.s}&periode1=${start}&periode2=${end}`
    };

    setSrc(url[active] + "&t=" + Date.now());
  };

  /* ===== LOGIN PAGE ===== */
  if(!user){
    return React.createElement("div",{className:"login card"},
      React.createElement("h2",null,"Login User"),
      React.createElement("input",{
        placeholder:"Username",
        onChange:e=>setUsername(e.target.value)
      }),
      React.createElement("button",{className:"primary",onClick:login},"LOGIN"),
      React.createElement("button",{
        className:"success",
        style:{marginTop:10},
        onClick:()=>window.open("https://wa.me/6287775798491","_blank")
      },"Hubungi Admin")
    );
  }

  /* ===== DASHBOARD ===== */
  return React.createElement("div",{className:"dashboard card"},
    React.createElement("div",{className:"header"},
      React.createElement("h3",null,`User: ${user.u} | Toko: ${user.s}`),
      React.createElement("button",{className:"danger",onClick:()=>{setUser(null);setSrc("");}},"Logout")
    ),

    React.createElement("div",{className:"grid"},
      React.createElement("button",{className:"primary",onClick:()=>setActive("last")},"SO Terakhir"),
      React.createElement("button",{className:"success",onClick:()=>setActive("all")},"SO Adjust"),
      React.createElement("button",{className:"warning",onClick:()=>setActive("plu")},"PLU Tidak Main"),
      React.createElement("button",{className:"danger",onClick:()=>setActive("daily")},"Daily Performance")
    ),

    active && React.createElement("div",{style:{marginTop:10}},
      active!=="daily" &&
        React.createElement("input",{type:"date",onChange:e=>setDate(formatDate(new Date(e.target.value)))}),

      active==="daily" &&
        React.createElement("input",{type:"date",onChange:e=>setStart(formatDate(new Date(e.target.value)))}),

      active==="daily" &&
        React.createElement("input",{type:"date",onChange:e=>setEnd(formatDate(new Date(e.target.value)))}),

      React.createElement("button",{className:"primary",style:{marginLeft:10},onClick:load},"Tampilkan")
    ),

    src && React.createElement("iframe",{src})
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(React.createElement(App));
</script>
</body>
</html>
